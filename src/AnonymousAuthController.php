<?php
/*
 * This file is part of Dvwzj\Anonymous.
 *
 * (c) dvwzj <iguphai_@msn.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
namespace Dvwzj\Anonymous;

use Flarum\Forum\Auth\Registration;
use Flarum\Forum\Auth\ResponseFactory;
use Flarum\Settings\SettingsRepositoryInterface;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface as Request;
use Psr\Http\Server\RequestHandlerInterface;

use Jenssegers\Agent\Agent;
use Illuminate\Support\Str;

class AnonymousAuthController implements RequestHandlerInterface
{
  /**
   * @var ResponseFactory
   */
  protected $response;
  /**
   * @param ResponseFactory $response
   */
  public function __construct(ResponseFactory $response, SettingsRepositoryInterface $settings)
  {
    $this->response = $response;
    $this->settings = $settings;
  }
  /**
   * @param Request $request
   * @return ResponseInterface
   */
  public function handle(Request $request): ResponseInterface
  {
    $user = $this->getUser($request);
    return $this->response->make(
      'anonymous', $user->email,
      function (Registration $registration) use ($user) {
        $registration
          ->provideTrustedEmail($user->email)
          ->suggestUsername($user->username)
          ->setPayload([
            'username' => $user->username,
            'email' => $user->email,
          ]);
        if (isset($user->avatar)) {
          $registration->provideAvatar($user->avatar);
        }
      }
    );
  }
  public function getUser($request) {
    $ipAddress = array_get($request->getServerParams(), 'REMOTE_ADDR', '127.0.0.1');
    $agent = new Agent();
    $platform = $agent->platform();
    $version = $agent->version($platform);
    $os = implode('-', [$platform, $version]);
    $username = substr(md5(Str::random(48)), 0, 16);
    $email = sprintf('%s.anonymous', implode('@', [bin2hex($ipAddress), bin2hex(strtolower($os))]));
    return (object) [
      'display_name' => 'Anonymeow',
      'username' => $username,
      'email' => $email,
      'avatar' => 'data:image/png;base64,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'
    ];
  }
}